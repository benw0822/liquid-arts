<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liquid Arts - Visual Experience</title>
    <meta name="description"
        content="‰ª•‰∏ñÁïåÂêÑÂú∞ÁöÑÈÖíÂêßÁÇ∫ÂàáÈªûÔºåÂª∂‰º∏Ëá≥Á©∫ÈñìË®≠Ë®à„ÄÅË™øÈÖíÊñáÂåñ„ÄÅÂú®Âú∞È¢®ÂúüËàáÁîüÊ¥ªÂì≤Â≠∏„ÄÇË¨õËø∞‰∫∫ËàáÈÖíÁöÑÊïÖ‰∫ã„ÄÅÂüéÂ∏ÇÁöÑÈùàÈ≠ÇËàáÂ§úËâ≤ÁöÑË™ûË®Ä„ÄÇLiquid Arts, Where The Night Becomes Art.">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Playfair+Display:ital,wght@0,400;0,700;1,400;1,700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <!-- Cropper.js -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
</head>

<body>
    <nav class="navbar">
        <div class="container nav-content" style="display: flex; align-items: center; justify-content: space-between;">
            <a href="index.html" class="logo">
                <img src="assets/logo_horizontal.png" alt="Liquid Arts" class="logo-img">
            </a>

            <!-- Desktop Nav Links -->
            <div class="nav-links" style="margin-left: 2rem;">
                <a href="bars.html" class="nav-link">Bars</a>
                <a href="map.html" class="nav-link">Map</a>
                <a href="journal.html" class="nav-link">Journal</a>
                <a href="events.html" class="nav-link">Event</a>
                <a href="msg.html" class="nav-link">Messages</a>
                <a href="about.html" class="nav-link">About</a>
            </div>

            <!-- Global Auth Button (Mobile & Desktop) -->
    </nav>

    <footer>
        <div class="container">
            <img src="assets/logo_vertical.png" alt="Liquid Arts" class="logo-img"
                style="height: 80px; width: auto; margin-bottom: 1rem;">
            <p>&copy; 2024 Liquid Arts. All rights reserved.</p>
            <p style="margin-top: 1rem; font-size: 0.8rem;"><a href="admin.html"
                    style="color: #333; text-decoration: none;">Admin Access</a></p>
        </div>
    </footer>

    <script src="js/app.js"></script>
    <script src="js/hopping.js"></script>
    <script src="js/talent_front.js"></script>
    <script>
        // Navbar Scroll Effect
        window.addEventListener('scroll', () => {
            const nav = document.querySelector('.navbar');
            if (window.scrollY > 50) {
                nav.classList.add('scrolled');
            } else {
                nav.classList.remove('scrolled');
            }
        });

        // --- Fetch & Render Latest Hops ---
        async function fetchLatestHops() {
            const grid = document.getElementById('hop-feed');
            if (!grid) return;

            // Adjust Layout for Feed Style (3-Column Grid)
            grid.classList.remove('masonry-grid');
            grid.style.display = 'grid';
            // Use responsive grid: 3 columns on desktop, fewer on smaller screens
            grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(300px, 1fr))';
            grid.style.gap = '40px'; // More whitespace
            grid.style.marginTop = '3rem';
            grid.style.width = '100%';
            grid.style.justifyContent = 'center';

            grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #888;">Loading latest hops...</p>';

            try {
                // Step 1: Fetch public hops with Bar data
                const { data: hopsData, error: hopsError } = await window.supabaseClient
                    .from('hoppings')
                    .select('*, bars(id, title)')
                    .eq('is_public', true)
                    .order('hopped_at', { ascending: false })
                    .limit(9); // Limit 9 for nice 3x3 grid

                if (hopsError) throw hopsError;

                if (!hopsData || hopsData.length === 0) {
                    grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #888;">No recent hops found.</p>';
                    return;
                }

                // Step 2: Fetch Users separately
                const userIds = [...new Set(hopsData.map(h => h.user_id).filter(Boolean))];
                let usersMap = {};

                if (userIds.length > 0) {
                    const { data: usersData } = await window.supabaseClient
                        .from('users')
                        .select('id, name, hopper_nickname, hopper_image_url')
                        .in('id', userIds);
                    if (usersData) usersData.forEach(u => { usersMap[u.id] = u; });
                }

                // Step 3: Fetch Latest Comments
                const hopIds = hopsData.map(h => h.id);
                let commentsMap = {};
                if (hopIds.length > 0) {
                    const { data: commentsData } = await window.supabaseClient
                        .from('hopping_comments')
                        .select('hopping_id, content, user:users(name, hopper_nickname, hopper_image_url)')
                        .in('hopping_id', hopIds)
                        .order('created_at', { ascending: false });

                    if (commentsData) {
                        commentsData.forEach(c => {
                            if (!commentsMap[c.hopping_id]) commentsMap[c.hopping_id] = c;
                        });
                    }
                }

                // Step 4: Render Cards in Grid
                grid.innerHTML = hopsData.map(hop => {
                    const dateObj = new Date(hop.hopped_at);
                    const dateStr = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) + ' ‚Ä¢ ' + dateObj.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    // Stars: Ensure Red Color
                    const stars = `<span style="color: var(--bg-red);">` + '‚òÖ'.repeat(hop.rating) + '</span>' + `<span style="color: #ddd;">` + '‚òÜ'.repeat(5 - hop.rating) + '</span>';

                    const u = usersMap[hop.user_id];
                    const userName = u?.hopper_nickname || u?.name || 'Anonymous';
                    const userAvatar = u?.hopper_image_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=random`;

                    const role = 'Hopper';

                    // Comments Pill
                    const latestComment = commentsMap[hop.id];
                    let commentHtml = '';
                    if (latestComment) {
                        const cUser = latestComment.user;
                        const cName = cUser?.hopper_nickname || cUser?.name || 'User';
                        const cAvatar = cUser?.hopper_image_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(cName)}&background=random`;

                        commentHtml = `
                        <div style="position: absolute; top: 15px; left: 15px; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); border-radius: 20px; padding: 4px 12px 4px 4px; display: flex; align-items: center; gap: 8px; max-width: 80%;">
                            <img src="${cAvatar}" style="width: 24px; height: 24px; border-radius: 50%; object-fit: cover; border: 1px solid rgba(255,255,255,0.5);">
                            <span style="color: #fff; font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                <strong style="margin-right: 4px;">${cName}:</strong> ${latestComment.content}
                            </span>
                        </div>
                        `;
                    }

                    // Description Logic: Only show if exists
                    const descriptionHtml = hop.description ? `
                        <p style="font-size: 0.95rem; color: #555; font-style: italic; font-family: 'Playfair Display', serif; line-height: 1.5; margin: 0;">
                            "${hop.description}"
                        </p>` : '';

                    return `
                    <div class="hop-feed-card" style="background: #fff; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.08); display: flex; flex-direction: column; width: 100%; max-width: 380px; margin: 0 auto;">
                        
                        <!-- Image Area -->
                        <div style="position: relative; width: 100%; padding-top: 100%;">
                            <img src="${hop.image_url}" style="position: absolute; top:0; left:0; width: 100%; height: 100%; object-fit: cover;">
                            
                            <!-- Comment Pill Overlay -->
                            ${commentHtml}

                            <!-- Removed Bar Pill from here -->
                        </div>

                        <!-- Content Area -->
                        <div style="padding: 0 1.5rem 1.5rem 1.5rem; text-align: center; position: relative;">
                            
                            <!-- Overlapping Avatar (Large) -->
                            <div style="margin-top: -40px; margin-bottom: 0.8rem; display: flex; justify-content: center;">
                                <img src="${userAvatar}" style="width: 80px; height: 80px; border-radius: 50%; border: 4px solid #fff; object-fit: cover; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            </div>

                            <!-- User Info -->
                            <div style="margin-bottom: 1rem;">
                                <div style="font-weight: 700; font-size: 1rem; color: #333;">${userName}</div>
                                <div style="font-size: 0.75rem; color: #888; text-transform: uppercase; letter-spacing: 0.05em;">${role}</div>
                            </div>

                            <!-- Actions (Large Buttons) -->
                            <div style="display: flex; justify-content: center; gap: 12px; margin-bottom: 1rem;">
                                <!-- Cheers (Red Icon) -->
                                <button style="background: #fff; border: 1px solid #eee; border-radius: 24px; padding: 10px 24px; display: flex; align-items: center; gap: 8px; color: #333; font-size: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--bg-red);">
                                        <path d="M8 22h8"></path>
                                        <path d="M12 11v11"></path>
                                        <path d="M5 4h14l-7 7-7-7z"></path>
                                    </svg>
                                    <span>0</span>
                                </button>
                                <!-- Message (Larger Circle) -->
                                <button style="background: #fff; border: 1px solid #eee; border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; color: #333; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                                </button>
                            </div>

                            <!-- Rating (Red) -->
                            <div style="font-size: 1.2rem; letter-spacing: 2px; margin-bottom: 0.5rem; color: #ddd;">${stars}</div>

                            <!-- Date -->
                            <div style="font-size: 0.7rem; color: #aaa; letter-spacing: 1px; margin-bottom: 0.8rem; text-transform: uppercase;">${dateStr}</div>

                            <!-- Bar Name (Moved Here) -->
                            <a href="bar-details.html?id=${hop.bars?.id}" style="display: flex; align-items: center; justify-content: center; gap: 4px; color: #666; font-size: 0.8rem; font-weight: 600; text-decoration: none; margin-bottom: 0.8rem;">
                                <span>üìç</span> ${hop.bars?.title || 'Unknown Bar'}
                            </a>

                            <!-- Description -->
                            ${descriptionHtml}

                        </div>
                    </div>
                    `;
                }).join('');

            } catch (err) {
                console.error('Error fetching hops:', JSON.stringify(err, null, 2));
                grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #ef4444;">Could not load recent hops.</p>';
            }
        }

        document.addEventListener('DOMContentLoaded', fetchLatestHops);
    </script>
</body>
<!-- Force Sync: 2025-12-09 01:28 -->

</html>