<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>BMS Debug</title>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #222;
            color: #0f0;
        }

        .log-entry {
            margin-bottom: 10px;
            border-bottom: 1px solid #444;
            padding-bottom: 5px;
        }

        .error {
            color: #f00;
        }

        .success {
            color: #0f0;
        }

        .warn {
            color: #fe0;
        }
    </style>
</head>

<body>
    <h1>BMS Data Access Debugger</h1>
    <div id="logs"></div>

    <script>
        // Supabase Config (from app.js/bms.js)
        const SUPABASE_URL = 'https://wgnskednopbfngvjmviq.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_gcmYleFIGmwsLSKofS__Qg_62EXoP6P';
        const sbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const logDiv = document.getElementById('logs');
        function log(msg, type = 'normal') {
            const el = document.createElement('div');
            el.className = `log-entry ${type}`;
            el.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logDiv.appendChild(el);
            console.log(msg);
        }

        async function runChecks() {
            log('Starting BMS Checks...');

            // 1. Check Auth
            const { data: { session }, error: authError } = await sbClient.auth.getSession();
            if (authError) {
                log('Auth Error: ' + authError.message, 'error');
                return;
            }
            if (!session) {
                log('No Active Session. Please login first.', 'warn');
                return;
            }
            log('User Logged In: ' + session.user.email, 'success');
            log('User ID: ' + session.user.id);

            // 2. Check Roles (users table)
            // 2. Check Roles (users table)
            log('Fetching User Roles...');
            const { data: profile, error: profileError } = await sbClient
                .from('users')
                .select('roles')
                .eq('id', session.user.id)
                .single();

            if (profileError) {
                log('Fetch Roles Failed: ' + profileError.message, 'error');
                log('Code: ' + profileError.code + ', Details: ' + profileError.details, 'error');
            } else {
                log('Roles Found: ' + JSON.stringify(profile.roles), 'success');
            }

            // 3. Check Bars Access (Read)
            log('Testing Bars Table Read Access...');
            const { data: bars, error: barsError } = await sbClient
                .from('bars')
                .select('id, title, slug')
                .limit(5);

            if (barsError) {
                log('Fetch Bars Failed: ' + barsError.message, 'error');
                log('Hint: Check RLS policies for "bars" table SELECT.', 'warn');
            } else {
                log(`Successfully fetched ${bars.length} bars.`, 'success');
                if (bars.length > 0) log('Sample: ' + bars[0].title);
            }

            // 4. Check Bar News (if applicable, user mentioned creating news table)
            log('Testing Bar News Table Read Access...');
            const { data: news, error: newsError } = await sbClient
                .from('bar_news')
                .select('*')
                .limit(5);

            if (newsError) {
                log('Fetch Bar News Failed: ' + newsError.message, 'error'); // Likely 404 if table doesn't exist yet
            } else {
                log(`Successfully fetched ${news ? news.length : 0} news items.`, 'success');
            }

        }

        runChecks();
    </script>
</body>

</html>