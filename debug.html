<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Hop Deletion Debug</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #222;
            color: #0f0;
        }

        .log-entry {
            margin-bottom: 5px;
            border-bottom: 1px solid #444;
        }

        .error {
            color: #f00;
        }

        .success {
            color: #0f0;
        }
    </style>
</head>

<body>
    <h1>Hop Soft Delete Debugger</h1>
    <div id="logs"></div>

    <script>
        const SUPABASE_URL = 'https://wgnskednopbfngvjmviq.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_gcmYleFIGmwsLSKofS__Qg_62EXoP6P';
        const sbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const logDiv = document.getElementById('logs');
        function log(msg, type = 'normal') {
            const el = document.createElement('div');
            el.className = `log-entry ${type}`;
            el.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logDiv.appendChild(el);
            console.log(msg);
        }

        async function runDebug() {
            log('Starting Delete Check...');

            // 1. Auth
            const { data: { session }, error: authError } = await sbClient.auth.getSession();
            if (authError || !session) {
                log('Auth Error or No Session', 'error');
                return;
            }
            log('Logged in as: ' + session.user.email);
            const myId = session.user.id;

            // 2. Fetch one of MY recent hops
            const { data: hops, error: fetchError } = await sbClient
                .from('hoppings')
                .select('*')
                .eq('user_id', myId)
                .is('is_deleted', false) // Use .is for null/boolean usually, but .eq works
                .limit(1);

            if (fetchError) {
                log('Fetch Error: ' + fetchError.message, 'error');
                return;
            }

            if (!hops || hops.length === 0) {
                log('No active hops found for this user to test delete on.', 'error');
                // Attempt to create a dummy one?
                log('Attempting to create a dummy hop for testing...');
                const { data: newHop, error: createError } = await sbClient
                    .from('hoppings')
                    .insert([{
                        user_id: myId,
                        bar_id: 19, // Assuming bar 19 exists
                        description: 'Debug Delete Test',
                        rating: 5,
                        image_url: 'https://placehold.co/100',
                        is_public: true
                    }])
                    .select()
                    .single();

                if (createError) {
                    log('Create Failed: ' + createError.message, 'error');
                    return;
                }
                log('Dummy Hop Created: ' + newHop.id, 'success');
                await testDelete(newHop.id);
            } else {
                const hop = hops[0];
                log(`Found Hop: ${hop.id} (${hop.description})`, 'success');
                // Wait for user confirmation? No, let's just try to update is_deleted
                // Warning: This WILL delete the hop if successful.
                await testDelete(hop.id);
            }
        }

        async function testDelete(hopId) {
            const confirmDel = confirm(`Test Soft Delete on Hop ID: ${hopId}?`);
            if (!confirmDel) return;

            log(`Attempting Soft Delete (update is_deleted=true) on ${hopId}...`);

            const { error } = await sbClient
                .from('hoppings')
                .update({ is_deleted: true })
                .eq('id', hopId);

            if (error) {
                log('Soft Delete FAILED: ' + error.message, 'error');
                log('Hint: Check RLS UPDATE policy for "hoppings".', 'error');
            } else {
                log('Soft Delete SUCCESS!', 'success');
            }
        }

        runDebug();
    </script>
</body>

</html>