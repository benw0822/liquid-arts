<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Auth & Data Diagnostic</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            background: #1a1a1a;
            color: #fff;
            font-family: monospace;
            padding: 20px;
        }

        .section {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 4px;
        }

        .success {
            color: #4ade80;
        }

        .error {
            color: #f87171;
        }

        .warn {
            color: #facc15;
        }

        button {
            padding: 10px 20px;
            background: #333;
            color: white;
            border: none;
            cursor: pointer;
        }

        button:hover {
            background: #555;
        }

        pre {
            background: #000;
            padding: 10px;
            overflow-x: auto;
        }
    </style>
</head>

<body>
    <h1>System Diagnostic</h1>
    <div id="status">Initializing...</div>

    <div class="section">
        <h3>1. Authentication Status</h3>
        <div id="auth-result">Pending...</div>
        <button onclick="logout()">Force Logout</button>
    </div>

    <div class="section">
        <h3>2. Data Test: Bars (Public Read)</h3>
        <button onclick="testFetch()">Test Fetch Now</button>
        <div id="data-result" style="margin-top: 10px;">Pending...</div>
    </div>

    <script>
        // CONFIG
        const SUPABASE_URL = 'https://wgnskednopbfngvjmviq.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_gcmYleFIGmwsLSKofS__Qg_62EXoP6P';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const authResult = document.getElementById('auth-result');
        const dataResult = document.getElementById('data-result');

        // 1. Check Auth
        async function checkAuth() {
            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                if (error) {
                    authResult.innerHTML = `<span class="error">Auth Error: ${error.message}</span>`;
                } else if (session) {
                    authResult.innerHTML = `<span class="success">LOGGED IN</span><br>User ID: ${session.user.id}<br>Email: ${session.user.email}<br>Role: ${session.user.role}`;
                } else {
                    authResult.innerHTML = `<span class="warn">GUEST MODE (Not Logged In)</span>`;
                }
            } catch (e) {
                authResult.innerHTML = `<span class="error">Exception: ${e.message}</span>`;
            }
        }

        // 2. Fetch Data
        async function testFetch() {
            dataResult.innerHTML = 'Fetching...';
            try {
                const { data, error } = await supabase
                    .from('bars')
                    .select('*, bar_images(image_url)'); // Test the Join too

                if (error) {
                    dataResult.innerHTML = `<span class="error">DB Error: ${error.message}</span><br>Code: ${error.code}`;
                } else {
                    if (data.length === 0) {
                        dataResult.innerHTML = `<span class="warn">Success, but EMPTY result (0 items).</span><br>Hint: RLS is hiding rows.`;
                    } else {
                        dataResult.innerHTML = `<span class="success">SUCCESS! Found ${data.length} bars.</span>`;
                        // Show first item
                        const sample = JSON.stringify(data[0], null, 2);
                        dataResult.innerHTML += `<pre>${sample}</pre>`;
                    }
                }
            } catch (e) {
                dataResult.innerHTML = `<span class="error">Fetch Exception: ${e.message}</span>`;
            }
        }

        async function logout() {
            await supabase.auth.signOut();
            window.location.reload();
        }

        // Run
        checkAuth();
        testFetch();

    </script>
</body>

</html>